#! /usr/bin/env ruby

begin
  require "vspheremonitoring"
  require "rbvmomi"
  require "json"
  require "yaml"
rescue LoadError
  puts 'Some of the required gems have not been found'
  exit
end

require 'optparse'

options = {}
OptionParser.new do |opts|
  opts.banner = "Usage: vspheremonitor [options]"

  opts.on("-v", "--verbose", "Be less quiet") do |v|
    options[:verbose] = v
  end

  opts.on("-c", "--config FILE", "Specify the configuration file") do |conf|
    options[:configfile] = conf
  end

end.parse!

def run (options)

  if options[:configfile].nil?
    configfile = 'etc/vsphere.yaml'
  else
    configfile = options[:configfile]
  end

  configfile = 'etc/vsphere.yaml' if options[:configfile].nil?

  config = YAML::load(File.read(configfile))
  vim = RbVmomi::VIM.connect :host     => config[:host],
                             :user     => config[:user],
                             :password => config[:password],
                             :insecure => true

  data = Hash.new
  data[:vsphere] = VSphereMonitoring.process_all_datacenters(config[:datacenters],vim)
  data

end

output = run(options)
puts output.to_json

